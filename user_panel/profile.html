<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мой Кабинет — Новая Жизнь</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00C853; --dark: #12141d; }
        body { font-family: 'Nunito', sans-serif; background: #f8f9fa; }
        .profile-header { background: var(--dark); color: white; padding: 60px 0; border-radius: 0 0 50px 50px; }
        .card { border: none; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.05); }
        .stat-card { background: white; padding: 30px; border-radius: 30px; border-bottom: 5px solid var(--primary); }
        .btn-logout { border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 15px; padding: 10px 20px; transition: 0.3s; }
        .btn-logout:hover { background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>
    <div class="profile-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="bg-primary p-4 rounded-circle me-4 shadow-lg">
                        <i class="bi bi-person-fill fs-1"></i>
                    </div>
                    <div>
                        <h2 class="fw-black mb-1" id="user-name">Загрузка...</h2>
                        <p class="opacity-50 mb-0" id="user-email">...</p>
                    </div>
                </div>
                <button class="btn btn-logout" onclick="logout()">Выйти <i class="bi bi-box-arrow-right ms-2"></i></button>
            </div>
        </div>
    </div>

    <div class="container py-5" style="margin-top: -40px;">
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="stat-card">
                    <h6 class="text-muted text-uppercase fw-bold small">Всего пожертвовано</h6>
                    <h2 class="fw-black text-primary mb-0" id="total-donated">0 ₽</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <h6 class="text-muted text-uppercase fw-bold small">Проектов поддержано</h6>
                    <h2 class="fw-black text-primary mb-0" id="projects-count">0</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <h6 class="text-muted text-uppercase fw-bold small">Ранг донора</h6>
                    <h2 class="fw-black text-primary mb-0">Хранитель</h2>
                </div>
            </div>
        </div>

        <h3 class="fw-black mb-4">История ваших добрых дел</h3>
        <div class="card p-0 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="px-4 py-3">Дата</th>
                            <th>Проект</th>
                            <th>Сумма</th>
                            <th class="text-end px-4">Статус</th>
                        </tr>
                    </thead>
                    <tbody id="donations-list">
                        <!-- JS Load -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        
        async function loadProfile() {
            const token = localStorage.getItem('token');
            if (!token) { window.location.href = '/index.html'; return; }

            try {
                const res = await fetch(`${API_URL}/auth/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Auth failed');
                const user = await res.json();
                
                document.getElementById('user-name').innerText = user.name || 'Благотворитель';
                document.getElementById('user-email').innerText = user.email;

                // Load donations
                const donRes = await fetch(`${API_URL}/payments/my-donations`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const donations = await donRes.json();
                
                let total = 0;
                document.getElementById('donations-list').innerHTML = donations.map(d => {
                    total += Number(d.amount);
                    return `
                        <tr>
                            <td class="px-4">${new Date(d.createdAt).toLocaleDateString()}</td>
                            <td class="fw-bold">${d.collection ? d.collection.title : 'Донат фонду'}</td>
                            <td class="text-primary fw-bold">${Number(d.amount).toLocaleString()} ₽</td>
                            <td class="text-end px-4"><span class="badge bg-success rounded-pill">Успешно</span></td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('total-donated').innerText = `${total.toLocaleString()} ₽`;
                document.getElementById('projects-count').innerText = new Set(donations.map(d => d.collection?.id).filter(id => id)).size;

            } catch (e) {
                console.error(e);
                localStorage.removeItem('token');
                window.location.href = '/index.html';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/index.html';
        }

        loadProfile();
    </script>
</body>
</html>
